{% extends 'base.html' %}
{% block content %}

<h1>Labs Management</h1>
<i class="fa-solid fa-info-circle my-3"></i> Note: Lab names must be unique.

{% if cam_management %}

<!-- Add New Lab Form -->
<div class="card mb-4">
    <div class="card-header">
        Create New Lab
    </div>

    <div class="card-body">
        <!-- Form -->
        <form method="post" action="{{ url_for('labs') }}">
            <div class="form-group my-1">
                <input type="hidden" name="action" value="add_lab">

                <label for="new_lab">Lab Name:</label>
                <input type="text" class="form-control" name="lab_name" id="new_lab" required>

                <!-- <label for="new_lab_email" class="my-2">Lab Safety Email:</label>
                <input type="email" class="form-control" name="lab_safety_email" id="new_lab_email" required> -->

                <!--                <label for="new_lab_telegram" class="my-2">Lab Safety Telegram:</label>-->
                <!--                <input type="telegram" class="form-control" name="lab_safety_telegram" id="new_lab_telegram"-->
                <!--                       value="{{ lab_safety_telegram }}">-->

                <!--                <div class="mt-3">-->
                <!--                    <h5>Login with Telegram</h5>-->
                <!--                    <div id="telegram-login-button">-->
                <!--                        <script async src="https://telegram.org/js/telegram-widget.js?7"-->
                <!--                                data-telegram-login="incompoop_bot"-->
                <!--                                data-size="large" data-userpic="false" data-request-access="write"-->
                <!--                                data-auth-url="https://rident-zoila-unhistoric.ngrok-free.dev/telegram_callback"-->
                <!--                                data-lang="en">-->
                <!--                        </script>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>

            <button type="submit" class="btn btn-primary mt-2">Add Lab</button>
        </form>
    </div>
</div>

{% if all_lab_details %}
    {% for labid, lab in all_lab_details.items() %}
    <h3>Lab: {{ lab.lab_name }}</h3>
    <table class="table">
        <thead>
        <tr>
            <th scope="col">ID</th>
            <th scope="col">Lab Name</th>
            <th scope="col">Update</th>
            <th scope="col">Delete</th>
        </tr>
        </thead>
        <tbody>
        
            <tr>
                <td>{{ lab.labid }}</td>

                <form method="post" action="{{ url_for('labs') }}">
                    <td>
                        <div class="form-group">
                            <input type="text" name="new_lab_name" class="form-control" value="{{ lab.lab_name }}">
                        </div>
                    </td>
                    <td>
                        <input type="hidden" name="action" value="update">
                        <input type="hidden" name="lab_id" value="{{ lab.labid }}">
                        <button type="submit" class="btn btn-primary">Update</button>
                    </td>
                </form>
                <form method="post" action="{{ url_for('labs') }}"
                    onsubmit="return confirm('WARNING: Are you sure you want to delete this lab? This action cannot be undone.')">
                    <td>
                    <input type="hidden" name="action" value="delete">
                    <input type="hidden" name="lab_id" value="{{ lab.labid }}">
                    <button type="submit" class="btn btn-danger">Delete</button>
                    </td>
                </form>
            </tr>
    
        </tbody>

    </table>
    
    {% if all_lab_emails[labid] %}
    <table class="table">
        <thead>
        <tr>
            <th scope="col">Email</th>
            <th scope="col">Telegram</th>
            <th scope="col">Update</th>
            <th scope="col">Delete</th>
        </tr>
        </thead>
        {% for staffid, email, telegram in all_lab_emails[labid] %}
        <tbody>
            <form method="post" action="{{ url_for('labs') }}">
            <tr>
                <td>
                    <input type="hidden" name="staffid" value="{{ staffid }}">
                    
                    <input type="email" name="email" value="{{ email }}" required class="form-control">
                    <input type="hidden" name="original_email" value="{{ email }}">
                    
                </td>
                <td>
                    <input type="text" name="telegram" value="{{ telegram }}" required class="form-control">
                    <input type="hidden" name="original_telegram" value="{{ telegram }}">
                </td>
                <td>
                    <button type="submit" name="action" value="update_lab_staff" class="btn btn-primary btn-sm">Update</button>
                </td>
                <td>
                    <button type="submit" name="action" value="delete_lab_staff" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this lab staff?');">Delete</button>
                </td>
            </tr>
            </form>

        </tbody>
        {% endfor %}
    </table>
    {% else %}
        <p>No safety contacts found.</p>
    {% endif %}
    <form method="post" action="{{ url_for('labs') }}">
        <input type="hidden" name="action" value="add_lab_staff">
        <input type="hidden" name="lab_id" value="{{ lab.labid }}">
        <div id="new-staff-container-{{ lab.labid }}"></div>
        <button type="button" onclick="addNewStaff({{ labid }})">+ Add Safety Staff</button>
        <button disabled type="submit" id="add-staff-btn-{{ lab.labid }}" class="btn btn-success btn-sm">Add Staff</button>
    </form>


    <br>
    <br>
    <hr>
    {% endfor %}


{% else %}
<p>No labs.</p>
{% endif %}
{% endif %}

<script>
    function addNewStaff(labId) {
      const container = document.getElementById(`new-staff-container-${labId}`);
      const addBtn = document.getElementById(`add-staff-btn-${labId}`);

      const div = document.createElement('div');
      div.classList.add('d-flex', 'mb-2', 'align-items-center');

      const emailInput = document.createElement('input');
      emailInput.type = 'email';
      emailInput.name = 'new_staff_email[]';  // This collects all new staff emails
      emailInput.placeholder = 'Email';
      emailInput.required = true;
      emailInput.classList.add('form-control', 'mr-2');

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => {
        div.remove();
        if (container.children.length === 0) {
            addBtn.disabled = true; // Only enable add button if there is at least 1 input entry
        }
      }

      div.appendChild(emailInput);
      div.appendChild(removeBtn);

      container.appendChild(div);
      addBtn.disabled = false;
  }

</script>


{% endblock %}

