{% extends 'base.html' %}
{% block content %}

<h1>Labs Management</h1>
<i class="fa-solid fa-info-circle my-3"></i> Note: Lab names must be unique.

{% if cam_management %}

<!-- Add New Lab Form -->
<div class="card mb-4">
    <div class="card-header">
        Create New Lab
    </div>

    <div class="card-body">
        <!-- Form -->
        <form method="post" action="{{ url_for('labs') }}">
            <div class="form-group my-1">
                <input type="hidden" name="action" value="add_lab">

                <label for="new_lab">Lab Name:</label>
                <input type="text" class="form-control" name="lab_name" id="new_lab" required>

                <!-- <label for="new_lab_email" class="my-2">Lab Safety Email:</label>
                <input type="email" class="form-control" name="lab_safety_email" id="new_lab_email" required> -->

                <!--                <label for="new_lab_telegram" class="my-2">Lab Safety Telegram:</label>-->
                <!--                <input type="telegram" class="form-control" name="lab_safety_telegram" id="new_lab_telegram"-->
                <!--                       value="{{ lab_safety_telegram }}">-->

                <!--                <div class="mt-3">-->
                <!--                    <h5>Login with Telegram</h5>-->
                <!--                    <div id="telegram-login-button">-->
                <!--                        <script async src="https://telegram.org/js/telegram-widget.js?7"-->
                <!--                                data-telegram-login="incompoop_bot"-->
                <!--                                data-size="large" data-userpic="false" data-request-access="write"-->
                <!--                                data-auth-url="https://rident-zoila-unhistoric.ngrok-free.dev/telegram_callback"-->
                <!--                                data-lang="en">-->
                <!--                        </script>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>

            <button type="submit" class="btn btn-primary mt-2">Add Lab</button>
        </form>
    </div>
</div>

{% if all_lab_details %}
{% for labid, lab in all_lab_details.items() %}
<div class="card mb-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0">Lab: {{ lab.lab_name }}</h3>
        <form method="post" action="{{ url_for('labs') }}"
            onsubmit="return confirm('WARNING: Are you sure you want to delete this lab? This action cannot be undone.')">
            <input type="hidden" name="action" value="delete">
            <input type="hidden" name="lab_id" value="{{ lab.labid }}">
            <button type="submit" class="btn btn-danger btn-sm">Delete Lab</button>
        </form>
    </div>
    <div class="card-body">
        <h5 class="card-title">Update Lab Name</h5>
        <form method="post" action="{{ url_for('labs') }}">
            <div class="row g-2 mb-4">
                <div class="col">
                    <label for="lab_name_{{ lab.labid }}" class="visually-hidden">Lab Name</label>
                    <input type="text" name="new_lab_name" id="lab_name_{{ lab.labid }}" class="form-control"
                        value="{{ lab.lab_name }}">
                </div>
                <div class="col-auto" style="width: 150px;">
                    <input type="hidden" name="action" value="update">
                    <input type="hidden" name="lab_id" value="{{ lab.labid }}">
                    <button type="submit" class="btn btn-primary btn-sm w-100">Update</button>
                </div>
            </div>
        </form>

        <hr>

        <h5 class="card-title mt-4">Safety Staff</h5>
        {% if all_lab_emails[labid] %}
        <table class="table table-borderless">
            <thead>
                <tr>
                    <th scope="col">Email</th>
                    <th scope="col">Telegram</th>
                    <th scope="col" colspan="2">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for staffid, email, telegram in all_lab_emails[labid] %}
                <form method="post" action="{{ url_for('labs') }}">
                    <tr>
                        <td class="w-auto">
                            <input type="hidden" name="staffid" value="{{ staffid }}">
                            <input type="email" name="email" value="{{ email }}" required class="form-control">
                            <input type="hidden" name="original_email" value="{{ email }}">
                        </td>
                        <td class="w-auto">
                            <input type="text" name="telegram" value="{{ telegram }}" required class="form-control">
                            <input type="hidden" name="original_telegram" value="{{ telegram }}">
                        </td>
                        <td style="width: 75px;">
                            <button type="submit" name="action" value="update_lab_staff"
                                class="btn btn-primary btn-sm w-100">Update</button>
                        </td>
                        <td style="width: 75px;">
                            <button type="submit" name="action" value="delete_lab_staff"
                                class="btn btn-danger btn-sm w-100"
                                onclick="return confirm('Are you sure you want to delete this lab staff?');">Delete</button>
                        </td>
                    </tr>
                </form>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No safety contacts found for this lab.</p>
        {% endif %}

        <div class="mt-4">
            <h5 class="card-title">Add New Safety Staff</h5>
            <form method="post" action="{{ url_for('labs') }}">
                <input type="hidden" name="action" value="add_lab_staff">
                <input type="hidden" name="lab_id" value="{{ lab.labid }}">
                <div id="new-staff-container-{{ lab.labid }}" class="mb-3"></div>
                <button type="button" id="start-add-staff-btn-{{ lab.labid }}" class="btn btn-primary btn-sm"
                    onclick="addNewStaff({{ labid }})">+ Add New Staff</button>
                <button type="button" id="add-another-staff-btn-{{ lab.labid }}" class="btn btn-secondary btn-sm d-none"
                    onclick="addNewStaff({{ labid }})">+ Add Another Staff Member</button>
                <button type="submit" id="save-staff-btn-{{ lab.labid }}" class="btn btn-success btn-sm d-none">Save New
                    Staff</button>
            </form>
        </div>
    </div>
</div>
{% endfor %}


{% else %}
<p>No labs.</p>
{% endif %}
{% endif %}

<script>
    function addNewStaff(labId) {
        const container = document.getElementById(`new-staff-container-${labId}`);
        const startBtn = document.getElementById(`start-add-staff-btn-${labId}`);
        const addAnotherBtn = document.getElementById(`add-another-staff-btn-${labId}`);
        const saveBtn = document.getElementById(`save-staff-btn-${labId}`);

        // Show/hide buttons
        startBtn.classList.add('d-none');
        addAnotherBtn.classList.remove('d-none');
        saveBtn.classList.remove('d-none');

        const div = document.createElement('div');
        div.classList.add('row', 'mb-2', 'g-2', 'align-items-center');

        // Email input
        const emailCol = document.createElement('div');
        emailCol.classList.add('col-md-5');
        const emailInput = document.createElement('input');
        emailInput.type = 'email';
        emailInput.name = 'new_staff_email[]';
        emailInput.placeholder = 'Staff Email';
        emailInput.required = true;
        emailInput.classList.add('form-control');
        emailCol.appendChild(emailInput);

        // Telegram input
        const telegramCol = document.createElement('div');
        telegramCol.classList.add('col-md-5');
        const telegramInput = document.createElement('input');
        telegramInput.type = 'text';
        telegramInput.name = 'new_staff_telegram[]';
        telegramInput.placeholder = 'Telegram Handle (e.g., @username)';
        telegramInput.required = true;
        telegramInput.classList.add('form-control');
        telegramCol.appendChild(telegramInput);

        // Remove button
        const removeCol = document.createElement('div');
        removeCol.classList.add('col-md-2');
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.classList.add('btn', 'btn-danger', 'btn-sm', 'w-100');
        removeBtn.textContent = 'Remove';
        removeBtn.onclick = () => {
            div.remove();
            // If no more new staff rows, revert buttons to initial state
            if (container.children.length === 0) {
                startBtn.classList.remove('d-none');
                addAnotherBtn.classList.add('d-none');
                saveBtn.classList.add('d-none');
            }
        }
        removeCol.appendChild(removeBtn);

        div.appendChild(emailCol);
        div.appendChild(telegramCol);
        div.appendChild(removeCol);

        container.appendChild(div);
    }

</script>


{% endblock %}