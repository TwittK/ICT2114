{% extends 'base.html' %}
{% block content %}

<h1>Labs Management</h1>
<i class="fa-solid fa-info-circle my-3"></i> Note: Lab names must be unique.

{% if cam_management %}

<!-- Add New Lab Form -->
<div class="card mb-4">
    <div class="card-header">
        Create New Lab
    </div>

    <div class="card-body">
        <!-- Form -->
        <form method="post" action="{{ url_for('labs') }}">
            <div class="form-group my-1">
                <input type="hidden" name="action" value="add_lab">

                <label for="new_lab">Lab Name:</label>
                <input type="text" class="form-control" name="lab_name" id="new_lab" required>

                <label for="new_lab_email" class="my-2">Lab Safety Email:</label>
                <input type="email" class="form-control" name="lab_safety_email" id="new_lab_email" required>

                <!--                <label for="new_lab_telegram" class="my-2">Lab Safety Telegram:</label>-->
                <!--                <input type="telegram" class="form-control" name="lab_safety_telegram" id="new_lab_telegram"-->
                <!--                       value="{{ lab_safety_telegram }}">-->

                <!--                <div class="mt-3">-->
                <!--                    <h5>Login with Telegram</h5>-->
                <!--                    <div id="telegram-login-button">-->
                <!--                        <script async src="https://telegram.org/js/telegram-widget.js?7"-->
                <!--                                data-telegram-login="incompoop_bot"-->
                <!--                                data-size="large" data-userpic="false" data-request-access="write"-->
                <!--                                data-auth-url="https://rident-zoila-unhistoric.ngrok-free.dev/telegram_callback"-->
                <!--                                data-lang="en">-->
                <!--                        </script>-->
                <!--                    </div>-->
                <!--                </div>-->
            </div>

            <button type="submit" class="btn btn-primary mt-2">Add Lab</button>
        </form>
    </div>
</div>

{% if all_lab_details %}
<table class="table">
    <thead>
    <tr>
        <th scope="col">ID</th>
        <th scope="col">Lab Name</th>
        <th scope="col" colspan="2">Lab Safety Staff (Email & Telegram)</th>
        <th scope="col">Update</th>
        <th scope="col">Delete</th>
    </tr>
    </thead>
    <tbody>
    {% for lab in all_lab_details %}
    <form method="post" action="{{ url_for('labs') }}">
        <tr>
            <td>{{ lab.labid }}</td>
            <td>
                <input type="text" name="new_lab_name" class="form-control" value="{{ lab.lab_name }}">
            </td>
            <td colspan="2">
                {% for staff in lab.safety_staff %}
                <input type="hidden" name="staff_ids" value="{{ staff.labsafetyid }}">
                <input type="email" name="staff_email_{{ staff.labsafetyid }}" class="form-control"
                       value="{{ staff.lab_safety_email }}" required>
                <input type="text" name="staff_telegram_{{ staff.labsafetyid }}" class="form-control"
                       value="{{ staff.lab_safety_telegram }}" required>
                <label><input type="checkbox" name="delete_staff_{{ staff.labsafetyid }}"> Delete</label>
                {% endfor %}

                <!-- Add new staff inputs container -->
                <div id="new-staff-container-{{ lab.labid }}"></div>
                <button type="button" onclick="addNewStaff({{ lab.labid }})">+ Add Safety Staff</button>
            </td>
            <td>
                <input type="hidden" name="action" value="update">
                <input type="hidden" name="lab_id" value="{{ lab.labid }}">
                <button type="submit" class="btn btn-primary">Update</button>
            </td>
        </tr>
    </form>

    <!-- Separate form for delete -->
    <form method="post" action="{{ url_for('labs') }}" onsubmit="return confirm('Are you sure?')">
        <input type="hidden" name="action" value="delete">
        <input type="hidden" name="lab_id" value="{{ lab.labid }}">
        <button type="submit" class="btn btn-danger">Delete</button>
    </form>
    {% endfor %}
    </tbody>

</table>

{% else %}
<p>No labs.</p>
{% endif %}
{% endif %}

<script>
    function addNewStaff(labId) {
      const container = document.getElementById(`new-staff-container-${labId}`);

      const div = document.createElement('div');
      div.classList.add('d-flex', 'mb-2', 'align-items-center');

      const emailInput = document.createElement('input');
      emailInput.type = 'email';
      emailInput.name = 'new_staff_email[]';  // This collects all new staff emails
      emailInput.placeholder = 'Email';
      emailInput.required = true;
      emailInput.classList.add('form-control', 'mr-2');

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.classList.add('btn', 'btn-danger', 'btn-sm');
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => div.remove();

      div.appendChild(emailInput);
      div.appendChild(removeBtn);

      container.appendChild(div);
  }

</script>


{% endblock %}

