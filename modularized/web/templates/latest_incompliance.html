<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latest Incompliances</title>
    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
        }

        #latest-image-container {
            width: 100vw;
            height: 100vh;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 10px;
            padding: 10px;
            box-sizing: border-box;
        }

        .image-cell {
            position: relative;
            background: #111;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .image-cell img {
            width: 100%;
            height: 85%;
            object-fit: contain;
            display: block;
        }

        .image-timestamp {
            color: #fff;
            font-size: 0.8rem;
            text-align: center;
            padding: 5px;
            background: rgba(0, 0, 0, 0.7);
            width: 100%;
            position: absolute;
            bottom: 0;
        }

        .no-images {
            grid-column: 1 / -1;
            grid-row: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }
    </style>
</head>

<body>
    <div id="latest-image-container">
        {% if image_url and image_url|length > 0 %}
        {% for url, time in image_url[:16] %}
        <div class="image-cell" data-timestamp="{{ time }}">
            <img src="{{ url_for('static', filename=url) }}" alt="Incompliance {{ loop.index }}">
            <div class="image-timestamp">{{ time.strftime('%Y-%m-%d %H:%M:%S') if time else 'Unknown' }}</div>
        </div>
        {% endfor %}
        {% for i in range(16 - image_url|length) %}
        <div class="image-cell">
            <p style="color: #666;">Waiting for image...</p>
        </div>
        {% endfor %}
        {% else %}
        <div class="no-images">
            <p>No incompliance images found.</p>
        </div>
        {% endif %}
    </div>

    <script>
        const MAX_IMAGES = 16; // 4x4 grid
        let imageQueue = [];

        // Initialize with existing images
        function initializeImages() {
            const cells = document.querySelectorAll('.image-cell');
            cells.forEach((cell) => {
                const img = cell.querySelector('img');
                const timestamp = cell.getAttribute('data-timestamp');
                const timestampDiv = cell.querySelector('.image-timestamp');

                if (img && timestamp) {
                    if (timestampDiv) {
                        timestampDiv.textContent = formatTimestamp(timestamp);
                    }
                    imageQueue.push({
                        url: img.src,
                        timestamp: timestamp
                    });
                }
            });
        }

        function updateGrid(newImages) {
            const sortedImages = newImages.sort((a, b) => {
                return new Date(b.timestamp) - new Date(a.timestamp);
            });

            // Keep only the latest 16 images
            imageQueue = sortedImages.slice(0, MAX_IMAGES);

            // Update the grid
            const container = document.getElementById('latest-image-container');
            container.innerHTML = '';

            imageQueue.forEach((img, index) => {
                const cell = document.createElement('div');
                cell.className = 'image-cell';
                cell.setAttribute('data-timestamp', img.timestamp);

                const imgElement = document.createElement('img');
                imgElement.src = img.url;
                imgElement.alt = `Incompliance ${index + 1}`;

                const timestampDiv = document.createElement('div');
                timestampDiv.className = 'image-timestamp';
                timestampDiv.textContent = formatTimestamp(img.timestamp);

                cell.appendChild(imgElement);
                cell.appendChild(timestampDiv);
                container.appendChild(cell);
            });

            // Fill remaining cells with placeholders
            for (let i = imageQueue.length; i < MAX_IMAGES; i++) {
                const cell = document.createElement('div');
                cell.className = 'image-cell';
                const placeholder = document.createElement('p');
                placeholder.style.color = '#666';
                placeholder.textContent = 'Waiting for image...';
                cell.appendChild(placeholder);
                container.appendChild(cell);
            }
        }

        function formatTimestamp(timestamp) {
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp || 'Unknown';
            }
        }

        function fetchLatestImages() {
            fetch('/latest_incompliance?format=json')
                .then(response => response.json())
                .then(data => {
                    if (data.images && data.images.length > 0) {
                        const newImages = data.images.map(item => ({
                            url: `/static/${item.url}`,
                            timestamp: item.time
                        }));
                        updateGrid(newImages);
                    }
                })
                .catch(error => {
                    console.error('Error fetching images:', error);
                });
        }

        // Initialize on page load
        initializeImages();

        // Poll every 5 seconds
        setInterval(fetchLatestImages, 5000);
    </script>
</body>

</html>